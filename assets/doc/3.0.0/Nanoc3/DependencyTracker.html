<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
  <head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" href="../style.css" type="text/css" charset="utf-8" />
<link rel="stylesheet" href="../custom.css" type="text/css" charset="utf-8" />
<link rel="stylesheet" href="../syntax_highlight.css" type="text/css" charset="utf-8" />

    <script src="../jquery.js" type="text/javascript" charset="utf-8"></script>
    <script src="../app.js" type="text/javascript" charset="utf-8"></script>
    <title>Class: Nanoc3::DependencyTracker</title>
  </head>
  <body>
    <div id="content">
      <div class="section class Nanoc3_DependencyTracker">
  <h1 class="title">Class: Nanoc3::DependencyTracker</h1>
  <div class="section docstring">
  <p>
Nanoc3::DependencyTracker is responsible for remembering dependencies
between items. It is used to speed up compilation by only letting an item
be recompiled when it is outdated or any of its dependencies (or
dependencies&#8217; dependencies, etc) is outdated.
</p>
<p>
The dependencies tracked by the dependency tracker are not dependencies
based on an item&#8217;s content. When one item uses an attribute of
another item, then this is also treated as a dependency. While dependencies
based on an item&#8217;s content (handled in Nanoc3::Compiler) cannot be
mutually recursive, the more general dependencies in
Nanoc3::DependencyTracker can (e.g. item A can use an attribute of item B
and vice versa without problems).
</p>

</div><div class="section attributes">
  <h1>Attributes</h1>

  
    <div class="instance">
      <h2>Instance Attributes</h2>
      <table>
      
        
        <tr class="">
          <th class='signature'>
            <span class='name'>filename</span>
          </td>
          <td class="readwrite">
            [<span id='filename-instance_method'>R</span><span id='filename=-instance_method'>W</span>] 
          </td>
          <td class="visibility">
            public
          </td>
          <td class="docstring">
            <p>
Sets the attribute <tt>filename</tt>.
</p>

            
          </td>
        </tr>
        
      
      </table>
    </div>
  
</div>
<div class="section constants">
  
</div><div class="section constructor">
<h1>Constructor Summary</h1>
  <div id="initialize-instance_method" class="section method">
  <div class="details_title">
    <div class='section methodsignature'>
    <tt class='def'>
      <span class='visibility'>public</span>
      <span class='return_types'></span>
      <span class='name'>initialize</span><span class='args'>(items)</span>
      <span class='block'></span>
    </tt>
  </div>

</div><div class="section docstring">
  <p>
FIXME The way the graph is stored is not exactly great. An adjacency matrix
(wrapped in a Graph class, perhaps) would be a lot easier to work with, and
it would not require an inverse graph to be maintained. Creates a new
dependency tracker for the given items.
</p>

</div><div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="source_code">
    <table>
      <tr>
        <td>
          <pre class="lines">


28
29
30
31
32
33
34
35</pre>
        </td>
        <td>
          <pre class="code"><span class="info file"># File 'lib/nanoc3/base/dependency_tracker.rb', line 28</span>

<span class='def def kw'>def</span> <span class='initialize identifier id'>initialize</span><span class='lparen token'>(</span><span class='items identifier id'>items</span><span class='rparen token'>)</span>
  <span class='@items ivar id'>@items</span> <span class='assign token'>=</span> <span class='items identifier id'>items</span>

  <span class='@filename ivar id'>@filename</span> <span class='assign token'>=</span> <span class='string val'>'tmp/dependencies'</span>

  <span class='@graph ivar id'>@graph</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span>
  <span class='@inverse_graph ivar id'>@inverse_graph</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span>
<span class='end end kw'>end</span>
</pre>
        </td>
      </tr>
    </table>
  </div>
</div>
</div>
</div>  <div class="section visibilitygroup public">
    <h1>Public Visibility</h1>
      <div class="section methodsummary instance public">
    <h1>Public Instance Method Summary</h1>
<table class="summary">
  
    <tr>
      <th class="signature">
        
          <span class='overload'>
            <span class='name'><a href="#all_dependencies_for-instance_method" title="#all_dependencies_for">#all_dependencies_for</a></span><span class='args'>(item)</span>
            <span class='block'></span>
          </span>
        
        
      </th>
      <td class="docstring">
        <p>
Returns all dependencies (direct and indirect) for <tt>item</tt>, i.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        
          <span class='overload'>
            <span class='name'><a href="#all_inverse_dependencies_for-instance_method" title="#all_inverse_dependencies_for">#all_inverse_dependencies_for</a></span><span class='args'>(item)</span>
            <span class='block'></span>
          </span>
        
        
      </th>
      <td class="docstring">
        <p>
Returns all inverse dependencies (direct and indirect) for <tt>item</tt>,
i.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        
          <span class='overload'>
            <span class='name'><a href="#direct_dependencies_for-instance_method" title="#direct_dependencies_for">#direct_dependencies_for</a></span><span class='args'>(item)</span>
            <span class='block'></span>
          </span>
        
        
      </th>
      <td class="docstring">
        <p>
Returns the direct dependencies for <tt>item</tt>, i.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        
          <span class='overload'>
            <span class='name'><a href="#direct_inverse_dependencies_for-instance_method" title="#direct_inverse_dependencies_for">#direct_inverse_dependencies_for</a></span><span class='args'>(item)</span>
            <span class='block'></span>
          </span>
        
        
      </th>
      <td class="docstring">
        <p>
Returns the direct inverse dependencies for <tt>item</tt>, i.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        
          <span class='overload'>
            <span class='name'><a href="#forget_dependencies_for-instance_method" title="#forget_dependencies_for">#forget_dependencies_for</a></span><span class='args'>(item)</span>
            <span class='block'></span>
          </span>
        
        
      </th>
      <td class="docstring">
        <p>
Empties the list of dependencies for the given item.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        
          <span class='overload'>
            <span class='name'><a href="#load_graph-instance_method" title="#load_graph">#load_graph</a></span><span class='args'></span>
            <span class='block'></span>
          </span>
        
        
      </th>
      <td class="docstring">
        <p>
Loads the dependency graph from the file specified by the <tt>filename</tt>
attribute.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        
          <span class='overload'>
            <span class='name'><a href="#mark_outdated_items-instance_method" title="#mark_outdated_items">#mark_outdated_items</a></span><span class='args'></span>
            <span class='block'></span>
          </span>
        
        
      </th>
      <td class="docstring">
        <p>
Traverses the dependency graph and marks all items that (directly or
indirectly) depend on an outdated item as outdated.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        
          <span class='overload'>
            <span class='name'><a href="#record_dependency-instance_method" title="#record_dependency">#record_dependency</a></span><span class='args'>(src, dst)</span>
            <span class='block'></span>
          </span>
        
        
      </th>
      <td class="docstring">
        <p>
Records a dependency from <tt>src</tt> to <tt>dst</tt> in the dependency
graph.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        
          <span class='overload'>
            <span class='name'><a href="#start-instance_method" title="#start">#start</a></span><span class='args'></span>
            <span class='block'></span>
          </span>
        
        
      </th>
      <td class="docstring">
        <p>
Starts listening for dependency messages (<tt>:visit_started</tt> and
<tt>:visit_ended</tt>) and start recording dependencies.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        
          <span class='overload'>
            <span class='name'><a href="#stop-instance_method" title="#stop">#stop</a></span><span class='args'></span>
            <span class='block'></span>
          </span>
        
        
      </th>
      <td class="docstring">
        <p>
Stop listening for dependency messages and stop recording dependencies.
</p>

        
      </td>
    </tr>
  
    <tr>
      <th class="signature">
        
          <span class='overload'>
            <span class='name'><a href="#store_graph-instance_method" title="#store_graph">#store_graph</a></span><span class='args'></span>
            <span class='block'></span>
          </span>
        
        
      </th>
      <td class="docstring">
        <p>
Stores the dependency graph into the file specified by the
<tt>filename</tt> attribute.
</p>

        
      </td>
    </tr>
  
</table>

  </div>
<div class="section methoddetails instance public">
  <h1>Public Instance Method Details</h1>
  
    <div class="method">
      <div class="method_header">
  <h3>all_dependencies_for</h3>
</div><div id="all_dependencies_for-instance_method" class="section method">
  <div class="details_title">
    <div class='section methodsignature'>
    <tt class='def'>
      <span class='visibility'>public</span>
      <span class='return_types'></span>
      <span class='name'>all_dependencies_for</span><span class='args'>(item)</span>
      <span class='block'></span>
    </tt>
  </div>

</div><div class="section docstring">
  <p>
Returns all dependencies (direct and indirect) for <tt>item</tt>, i.e. the
items that, when outdated, will cause <tt>item</tt> to be marked as
outdated.
</p>

</div><div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="source_code">
    <table>
      <tr>
        <td>
          <pre class="lines">


78
79
80
81
82
83
84
85</pre>
        </td>
        <td>
          <pre class="code"><span class="info file"># File 'lib/nanoc3/base/dependency_tracker.rb', line 78</span>

<span class='def def kw'>def</span> <span class='all_dependencies_for identifier id'>all_dependencies_for</span><span class='lparen token'>(</span><span class='item identifier id'>item</span><span class='rparen token'>)</span>
  <span class='comment val'># FIXME can result in an infinite loop</span>

  <span class='direct_dependencies identifier id'>direct_dependencies</span>   <span class='assign token'>=</span> <span class='direct_dependencies_for identifier id'>direct_dependencies_for</span><span class='lparen token'>(</span><span class='item identifier id'>item</span><span class='rparen token'>)</span>
  <span class='indirect_dependencies identifier id'>indirect_dependencies</span> <span class='assign token'>=</span> <span class='direct_dependencies identifier id'>direct_dependencies</span><span class='dot token'>.</span><span class='map identifier id'>map</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='i identifier id'>i</span><span class='bitor op'>|</span> <span class='all_dependencies_for identifier id'>all_dependencies_for</span><span class='lparen token'>(</span><span class='i identifier id'>i</span><span class='rparen token'>)</span> <span class='rbrace token'>}</span>

  <span class='lparen token'>(</span><span class='direct_dependencies identifier id'>direct_dependencies</span> <span class='plus op'>+</span> <span class='indirect_dependencies identifier id'>indirect_dependencies</span><span class='rparen token'>)</span><span class='dot token'>.</span><span class='flatten identifier id'>flatten</span>
<span class='end end kw'>end</span>
</pre>
        </td>
      </tr>
    </table>
  </div>
</div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>all_inverse_dependencies_for</h3>
</div><div id="all_inverse_dependencies_for-instance_method" class="section method">
  <div class="details_title">
    <div class='section methodsignature'>
    <tt class='def'>
      <span class='visibility'>public</span>
      <span class='return_types'></span>
      <span class='name'>all_inverse_dependencies_for</span><span class='args'>(item)</span>
      <span class='block'></span>
    </tt>
  </div>

</div><div class="section docstring">
  <p>
Returns all inverse dependencies (direct and indirect) for <tt>item</tt>,
i.e. the items that will be marked as outdated when <tt>item</tt> is
outdated.
</p>

</div><div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="source_code">
    <table>
      <tr>
        <td>
          <pre class="lines">


97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119</pre>
        </td>
        <td>
          <pre class="code"><span class="info file"># File 'lib/nanoc3/base/dependency_tracker.rb', line 97</span>

<span class='def def kw'>def</span> <span class='all_inverse_dependencies_for identifier id'>all_inverse_dependencies_for</span><span class='lparen token'>(</span><span class='item identifier id'>item</span><span class='rparen token'>)</span>
  <span class='comment val'># Init list of all found dependencies</span>
  <span class='all_dependencies identifier id'>all_dependencies</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>

  <span class='comment val'># Init lists with already checked and not yet checked dependencies</span>
  <span class='checked_direct_dependencies identifier id'>checked_direct_dependencies</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>
  <span class='pending_direct_dependencies identifier id'>pending_direct_dependencies</span> <span class='assign token'>=</span> <span class='direct_inverse_dependencies_for identifier id'>direct_inverse_dependencies_for</span><span class='lparen token'>(</span><span class='item identifier id'>item</span><span class='rparen token'>)</span>

  <span class='while while kw'>while</span> <span class='notop op'>!</span><span class='pending_direct_dependencies identifier id'>pending_direct_dependencies</span><span class='dot token'>.</span><span class='empty? fid id'>empty?</span>
    <span class='comment val'># Get next unchecked dependency</span>
    <span class='dependency identifier id'>dependency</span> <span class='assign token'>=</span> <span class='pending_direct_dependencies identifier id'>pending_direct_dependencies</span><span class='dot token'>.</span><span class='shift identifier id'>shift</span>
    <span class='next next kw'>next</span> <span class='if if_mod kw'>if</span> <span class='checked_direct_dependencies identifier id'>checked_direct_dependencies</span><span class='dot token'>.</span><span class='include? fid id'>include?</span><span class='lparen token'>(</span><span class='dependency identifier id'>dependency</span><span class='rparen token'>)</span>

    <span class='comment val'># Add dependencies of this unchecked dependency</span>
    <span class='pending_direct_dependencies identifier id'>pending_direct_dependencies</span> <span class='opasgn op'>+=</span> <span class='direct_inverse_dependencies_for identifier id'>direct_inverse_dependencies_for</span><span class='lparen token'>(</span><span class='dependency identifier id'>dependency</span><span class='rparen token'>)</span>

    <span class='comment val'># Mark this dependency as handled</span>
    <span class='all_dependencies identifier id'>all_dependencies</span> <span class='lshft op'>&lt;&lt;</span> <span class='dependency identifier id'>dependency</span>
    <span class='checked_direct_dependencies identifier id'>checked_direct_dependencies</span> <span class='lshft op'>&lt;&lt;</span> <span class='dependency identifier id'>dependency</span>
  <span class='end end kw'>end</span>

  <span class='all_dependencies identifier id'>all_dependencies</span>
<span class='end end kw'>end</span>
</pre>
        </td>
      </tr>
    </table>
  </div>
</div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>direct_dependencies_for</h3>
</div><div id="direct_dependencies_for-instance_method" class="section method">
  <div class="details_title">
    <div class='section methodsignature'>
    <tt class='def'>
      <span class='visibility'>public</span>
      <span class='return_types'></span>
      <span class='name'>direct_dependencies_for</span><span class='args'>(item)</span>
      <span class='block'></span>
    </tt>
  </div>

</div><div class="section docstring">
  <p>
Returns the direct dependencies for <tt>item</tt>, i.e. the items that,
when outdated, will cause <tt>item</tt> to be marked as outdated. Indirect
dependencies will not be returned (e.g. if A depends on B which depends on
C, then the direct dependencies of A do not include C).
</p>

</div><div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="source_code">
    <table>
      <tr>
        <td>
          <pre class="lines">


72
73
74</pre>
        </td>
        <td>
          <pre class="code"><span class="info file"># File 'lib/nanoc3/base/dependency_tracker.rb', line 72</span>

<span class='def def kw'>def</span> <span class='direct_dependencies_for identifier id'>direct_dependencies_for</span><span class='lparen token'>(</span><span class='item identifier id'>item</span><span class='rparen token'>)</span>
  <span class='@graph ivar id'>@graph</span><span class='lbrack token'>[</span><span class='item identifier id'>item</span><span class='rbrack token'>]</span> <span class='orop op'>||</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>
<span class='end end kw'>end</span>
</pre>
        </td>
      </tr>
    </table>
  </div>
</div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>direct_inverse_dependencies_for</h3>
</div><div id="direct_inverse_dependencies_for-instance_method" class="section method">
  <div class="details_title">
    <div class='section methodsignature'>
    <tt class='def'>
      <span class='visibility'>public</span>
      <span class='return_types'></span>
      <span class='name'>direct_inverse_dependencies_for</span><span class='args'>(item)</span>
      <span class='block'></span>
    </tt>
  </div>

</div><div class="section docstring">
  <p>
Returns the direct inverse dependencies for <tt>item</tt>, i.e. the items
that will be marked as outdated when <tt>item</tt> is outdated. Indirect
dependencies will not be returned (e.g. if A depends on B which depends on
C, then the direct inverse dependencies of C do not include A).
</p>

</div><div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="source_code">
    <table>
      <tr>
        <td>
          <pre class="lines">


91
92
93</pre>
        </td>
        <td>
          <pre class="code"><span class="info file"># File 'lib/nanoc3/base/dependency_tracker.rb', line 91</span>

<span class='def def kw'>def</span> <span class='direct_inverse_dependencies_for identifier id'>direct_inverse_dependencies_for</span><span class='lparen token'>(</span><span class='item identifier id'>item</span><span class='rparen token'>)</span>
  <span class='inverted_graph identifier id'>inverted_graph</span><span class='lbrack token'>[</span><span class='item identifier id'>item</span><span class='rbrack token'>]</span> <span class='orop op'>||</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>
<span class='end end kw'>end</span>
</pre>
        </td>
      </tr>
    </table>
  </div>
</div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>forget_dependencies_for</h3>
</div><div id="forget_dependencies_for-instance_method" class="section method">
  <div class="details_title">
    <div class='section methodsignature'>
    <tt class='def'>
      <span class='visibility'>public</span>
      <span class='return_types'></span>
      <span class='name'>forget_dependencies_for</span><span class='args'>(item)</span>
      <span class='block'></span>
    </tt>
  </div>

</div><div class="section docstring">
  <p>
Empties the list of dependencies for the given item. This is necessary
before recompiling the given item, because otherwise old dependencies will
stick around and new dependencies will appear twice.
</p>

</div><div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="source_code">
    <table>
      <tr>
        <td>
          <pre class="lines">


225
226
227</pre>
        </td>
        <td>
          <pre class="code"><span class="info file"># File 'lib/nanoc3/base/dependency_tracker.rb', line 225</span>

<span class='def def kw'>def</span> <span class='forget_dependencies_for identifier id'>forget_dependencies_for</span><span class='lparen token'>(</span><span class='item identifier id'>item</span><span class='rparen token'>)</span>
  <span class='@graph ivar id'>@graph</span><span class='lbrack token'>[</span><span class='item identifier id'>item</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>
<span class='end end kw'>end</span>
</pre>
        </td>
      </tr>
    </table>
  </div>
</div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>load_graph</h3>
</div><div id="load_graph-instance_method" class="section method">
  <div class="details_title">
    <div class='section methodsignature'>
    <tt class='def'>
      <span class='visibility'>public</span>
      <span class='return_types'></span>
      <span class='name'>load_graph</span><span class='args'></span>
      <span class='block'></span>
    </tt>
  </div>

</div><div class="section docstring">
  <p>
Loads the dependency graph from the file specified by the <tt>filename</tt>
attribute. This method will overwrite an existing dependency graph.
</p>

</div><div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="source_code">
    <table>
      <tr>
        <td>
          <pre class="lines">


166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185</pre>
        </td>
        <td>
          <pre class="code"><span class="info file"># File 'lib/nanoc3/base/dependency_tracker.rb', line 166</span>

<span class='def def kw'>def</span> <span class='load_graph identifier id'>load_graph</span>
  <span class='comment val'># Create new graph</span>
  <span class='@graph ivar id'>@graph</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span>

  <span class='comment val'># Don't do anything if dependencies haven't been stored yet</span>
  <span class='return return kw'>return</span> <span class='if if_mod kw'>if</span> <span class='notop op'>!</span><span class='File constant id'>File</span><span class='dot token'>.</span><span class='file? fid id'>file?</span><span class='lparen token'>(</span><span class='self self kw'>self</span><span class='dot token'>.</span><span class='filename identifier id'>filename</span><span class='rparen token'>)</span>

  <span class='comment val'># Load dependencies</span>
  <span class='store identifier id'>store</span> <span class='assign token'>=</span> <span class='PStore constant id'>PStore</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='self self kw'>self</span><span class='dot token'>.</span><span class='filename identifier id'>filename</span><span class='rparen token'>)</span>
  <span class='store identifier id'>store</span><span class='dot token'>.</span><span class='transaction identifier id'>transaction</span> <span class='do do kw'>do</span>
    <span class='comment val'># Convert graph of identifiers into graph of items</span>
    <span class='store identifier id'>store</span><span class='lbrack token'>[</span><span class='symbol val'>:dependencies</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='each_pair identifier id'>each_pair</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='second_item_identifier identifier id'>second_item_identifier</span><span class='comma token'>,</span> <span class='first_item_identifiers identifier id'>first_item_identifiers</span><span class='bitor op'>|</span>
      <span class='comment val'># Convert second and first item identifiers into items</span>
      <span class='second_item identifier id'>second_item</span> <span class='assign token'>=</span> <span class='item_with_identifier identifier id'>item_with_identifier</span><span class='lparen token'>(</span><span class='second_item_identifier identifier id'>second_item_identifier</span><span class='rparen token'>)</span>
      <span class='first_items identifier id'>first_items</span> <span class='assign token'>=</span> <span class='first_item_identifiers identifier id'>first_item_identifiers</span><span class='dot token'>.</span><span class='map identifier id'>map</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='p identifier id'>p</span><span class='bitor op'>|</span> <span class='item_with_identifier identifier id'>item_with_identifier</span><span class='lparen token'>(</span><span class='p identifier id'>p</span><span class='rparen token'>)</span> <span class='rbrace token'>}</span>

      <span class='@graph ivar id'>@graph</span><span class='lbrack token'>[</span><span class='second_item identifier id'>second_item</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='first_items identifier id'>first_items</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre>
        </td>
      </tr>
    </table>
  </div>
</div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>mark_outdated_items</h3>
</div><div id="mark_outdated_items-instance_method" class="section method">
  <div class="details_title">
    <div class='section methodsignature'>
    <tt class='def'>
      <span class='visibility'>public</span>
      <span class='return_types'></span>
      <span class='name'>mark_outdated_items</span><span class='args'></span>
      <span class='block'></span>
    </tt>
  </div>

</div><div class="section docstring">
  <p>
Traverses the dependency graph and marks all items that (directly or
indirectly) depend on an outdated item as outdated.
</p>

</div><div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="source_code">
    <table>
      <tr>
        <td>
          <pre class="lines">


189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220</pre>
        </td>
        <td>
          <pre class="code"><span class="info file"># File 'lib/nanoc3/base/dependency_tracker.rb', line 189</span>

<span class='def def kw'>def</span> <span class='mark_outdated_items identifier id'>mark_outdated_items</span>
  <span class='comment val'># Unmark everything</span>
  <span class='@items ivar id'>@items</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='i identifier id'>i</span><span class='bitor op'>|</span> <span class='i identifier id'>i</span><span class='dot token'>.</span><span class='dependencies_outdated identifier id'>dependencies_outdated</span> <span class='assign token'>=</span> <span class='false false kw'>false</span> <span class='rbrace token'>}</span>

  <span class='comment val'># Mark items that appear in @items but not in the dependency graph</span>
  <span class='added_items identifier id'>added_items</span> <span class='assign token'>=</span> <span class='@items ivar id'>@items</span> <span class='minus op'>-</span> <span class='@graph ivar id'>@graph</span><span class='dot token'>.</span><span class='keys identifier id'>keys</span>
  <span class='added_items identifier id'>added_items</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='i identifier id'>i</span><span class='bitor op'>|</span> <span class='i identifier id'>i</span><span class='dot token'>.</span><span class='dependencies_outdated identifier id'>dependencies_outdated</span> <span class='assign token'>=</span> <span class='true true kw'>true</span> <span class='rbrace token'>}</span>

  <span class='comment val'># Walk graph and mark items as outdated if necessary</span>
  <span class='comment val'># (#keys and #sort is used instead of #each_pair to add determinism)</span>
  <span class='first_items identifier id'>first_items</span> <span class='assign token'>=</span> <span class='inverted_graph identifier id'>inverted_graph</span><span class='dot token'>.</span><span class='keys identifier id'>keys</span><span class='dot token'>.</span><span class='sort_by identifier id'>sort_by</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='i identifier id'>i</span><span class='bitor op'>|</span> <span class='i identifier id'>i</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span> <span class='integer val'>? </span><span class='string val'>'/'</span> <span class='colon op'>:</span> <span class='i identifier id'>i</span><span class='dot token'>.</span><span class='identifier identifier id'>identifier</span> <span class='rbrace token'>}</span>
  <span class='something_changed identifier id'>something_changed</span> <span class='assign token'>=</span> <span class='true true kw'>true</span>
  <span class='while while kw'>while</span> <span class='something_changed identifier id'>something_changed</span>
    <span class='something_changed identifier id'>something_changed</span> <span class='assign token'>=</span> <span class='false false kw'>false</span>

    <span class='first_items identifier id'>first_items</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='first_item identifier id'>first_item</span><span class='bitor op'>|</span>
      <span class='second_items identifier id'>second_items</span> <span class='assign token'>=</span> <span class='inverted_graph identifier id'>inverted_graph</span><span class='lbrack token'>[</span><span class='first_item identifier id'>first_item</span><span class='rbrack token'>]</span>

      <span class='if if kw'>if</span> <span class='first_item identifier id'>first_item</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span> <span class='orop op'>||</span>                <span class='comment val'># item was removed</span>
         <span class='first_item identifier id'>first_item</span><span class='dot token'>.</span><span class='outdated? fid id'>outdated?</span> <span class='orop op'>||</span>           <span class='comment val'># item itself is outdated</span>
         <span class='first_item identifier id'>first_item</span><span class='dot token'>.</span><span class='dependencies_outdated? fid id'>dependencies_outdated?</span> <span class='comment val'># item is outdated because of its dependencies</span>
        <span class='second_items identifier id'>second_items</span><span class='dot token'>.</span><span class='each identifier id'>each</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='item identifier id'>item</span><span class='bitor op'>|</span>
          <span class='comment val'># Ignore this item</span>
          <span class='next next kw'>next</span> <span class='if if_mod kw'>if</span> <span class='item identifier id'>item</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>

          <span class='something_changed identifier id'>something_changed</span> <span class='assign token'>=</span> <span class='true true kw'>true</span> <span class='if if_mod kw'>if</span> <span class='notop op'>!</span><span class='item identifier id'>item</span><span class='dot token'>.</span><span class='dependencies_outdated? fid id'>dependencies_outdated?</span>
          <span class='item identifier id'>item</span><span class='dot token'>.</span><span class='dependencies_outdated identifier id'>dependencies_outdated</span> <span class='assign token'>=</span> <span class='true true kw'>true</span>
        <span class='end end kw'>end</span>
      <span class='end end kw'>end</span>
    <span class='end end kw'>end</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre>
        </td>
      </tr>
    </table>
  </div>
</div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>record_dependency</h3>
</div><div id="record_dependency-instance_method" class="section method">
  <div class="details_title">
    <div class='section methodsignature'>
    <tt class='def'>
      <span class='visibility'>public</span>
      <span class='return_types'></span>
      <span class='name'>record_dependency</span><span class='args'>(src, dst)</span>
      <span class='block'></span>
    </tt>
  </div>

</div><div class="section docstring">
  <p>
Records a dependency from <tt>src</tt> to <tt>dst</tt> in the dependency
graph. When <tt>dst</tt> is oudated, <tt>src</tt> will also become
outdated.
</p>

</div><div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="source_code">
    <table>
      <tr>
        <td>
          <pre class="lines">


123
124
125
126
127
128
129
130
131
132
133
134</pre>
        </td>
        <td>
          <pre class="code"><span class="info file"># File 'lib/nanoc3/base/dependency_tracker.rb', line 123</span>

<span class='def def kw'>def</span> <span class='record_dependency identifier id'>record_dependency</span><span class='lparen token'>(</span><span class='src identifier id'>src</span><span class='comma token'>,</span> <span class='dst identifier id'>dst</span><span class='rparen token'>)</span>
  <span class='comment val'># Initialize graph if necessary</span>
  <span class='@graph ivar id'>@graph</span><span class='lbrack token'>[</span><span class='src identifier id'>src</span><span class='rbrack token'>]</span> <span class='opasgn op'>||=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>

  <span class='comment val'># Don't include self or doubles in dependencies</span>
  <span class='return return kw'>return</span> <span class='if if_mod kw'>if</span> <span class='src identifier id'>src</span> <span class='eq op'>==</span> <span class='dst identifier id'>dst</span>
  <span class='return return kw'>return</span> <span class='if if_mod kw'>if</span> <span class='@graph ivar id'>@graph</span><span class='lbrack token'>[</span><span class='src identifier id'>src</span><span class='rbrack token'>]</span><span class='dot token'>.</span><span class='include? fid id'>include?</span><span class='lparen token'>(</span><span class='dst identifier id'>dst</span><span class='rparen token'>)</span>

  <span class='comment val'># Record dependency</span>
  <span class='invalidate_inverted_graph identifier id'>invalidate_inverted_graph</span>
  <span class='@graph ivar id'>@graph</span><span class='lbrack token'>[</span><span class='src identifier id'>src</span><span class='rbrack token'>]</span> <span class='lshft op'>&lt;&lt;</span> <span class='dst identifier id'>dst</span>
<span class='end end kw'>end</span>
</pre>
        </td>
      </tr>
    </table>
  </div>
</div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>start</h3>
</div><div id="start-instance_method" class="section method">
  <div class="details_title">
    <div class='section methodsignature'>
    <tt class='def'>
      <span class='visibility'>public</span>
      <span class='return_types'></span>
      <span class='name'>start</span><span class='args'></span>
      <span class='block'></span>
    </tt>
  </div>

</div><div class="section docstring">
  <p>
Starts listening for dependency messages (<tt>:visit_started</tt> and
<tt>:visit_ended</tt>) and start recording dependencies.
</p>

</div><div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="source_code">
    <table>
      <tr>
        <td>
          <pre class="lines">


39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59</pre>
        </td>
        <td>
          <pre class="code"><span class="info file"># File 'lib/nanoc3/base/dependency_tracker.rb', line 39</span>

<span class='def def kw'>def</span> <span class='start identifier id'>start</span>
  <span class='comment val'># Initialize dependency stack. An item will be pushed onto this stack</span>
  <span class='comment val'># when it is visited. Therefore, an item on the stack always depends on</span>
  <span class='comment val'># all items pushed above it.</span>
  <span class='@stack ivar id'>@stack</span> <span class='assign token'>=</span> <span class='lbrack token'>[</span><span class='rbrack token'>]</span>

  <span class='comment val'># Register start of visits</span>
  <span class='Nanoc3 constant id'>Nanoc3</span><span class='colon2 op'>::</span><span class='NotificationCenter constant id'>NotificationCenter</span><span class='dot token'>.</span><span class='on identifier id'>on</span><span class='lparen token'>(</span><span class='symbol val'>:visit_started</span><span class='comma token'>,</span> <span class='self self kw'>self</span><span class='rparen token'>)</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='item identifier id'>item</span><span class='bitor op'>|</span>
    <span class='comment val'># Record possible dependency</span>
    <span class='unless unless kw'>unless</span> <span class='@stack ivar id'>@stack</span><span class='dot token'>.</span><span class='empty? fid id'>empty?</span>
      <span class='self self kw'>self</span><span class='dot token'>.</span><span class='record_dependency identifier id'>record_dependency</span><span class='lparen token'>(</span><span class='@stack ivar id'>@stack</span><span class='lbrack token'>[</span><span class='integer val'>-1</span><span class='rbrack token'>]</span><span class='comma token'>,</span> <span class='item identifier id'>item</span><span class='rparen token'>)</span>
    <span class='end end kw'>end</span>

    <span class='@stack ivar id'>@stack</span><span class='dot token'>.</span><span class='push identifier id'>push</span><span class='lparen token'>(</span><span class='item identifier id'>item</span><span class='rparen token'>)</span>
  <span class='end end kw'>end</span>

  <span class='comment val'># Register end of visits</span>
  <span class='Nanoc3 constant id'>Nanoc3</span><span class='colon2 op'>::</span><span class='NotificationCenter constant id'>NotificationCenter</span><span class='dot token'>.</span><span class='on identifier id'>on</span><span class='lparen token'>(</span><span class='symbol val'>:visit_ended</span><span class='comma token'>,</span> <span class='self self kw'>self</span><span class='rparen token'>)</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='item identifier id'>item</span><span class='bitor op'>|</span>
    <span class='@stack ivar id'>@stack</span><span class='dot token'>.</span><span class='pop identifier id'>pop</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre>
        </td>
      </tr>
    </table>
  </div>
</div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>stop</h3>
</div><div id="stop-instance_method" class="section method">
  <div class="details_title">
    <div class='section methodsignature'>
    <tt class='def'>
      <span class='visibility'>public</span>
      <span class='return_types'></span>
      <span class='name'>stop</span><span class='args'></span>
      <span class='block'></span>
    </tt>
  </div>

</div><div class="section docstring">
  <p>
Stop listening for dependency messages and stop recording dependencies.
</p>

</div><div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="source_code">
    <table>
      <tr>
        <td>
          <pre class="lines">


62
63
64
65
66</pre>
        </td>
        <td>
          <pre class="code"><span class="info file"># File 'lib/nanoc3/base/dependency_tracker.rb', line 62</span>

<span class='def def kw'>def</span> <span class='stop identifier id'>stop</span>
  <span class='comment val'># Unregister</span>
  <span class='Nanoc3 constant id'>Nanoc3</span><span class='colon2 op'>::</span><span class='NotificationCenter constant id'>NotificationCenter</span><span class='dot token'>.</span><span class='remove identifier id'>remove</span><span class='lparen token'>(</span><span class='symbol val'>:visit_started</span><span class='comma token'>,</span> <span class='self self kw'>self</span><span class='rparen token'>)</span>
  <span class='Nanoc3 constant id'>Nanoc3</span><span class='colon2 op'>::</span><span class='NotificationCenter constant id'>NotificationCenter</span><span class='dot token'>.</span><span class='remove identifier id'>remove</span><span class='lparen token'>(</span><span class='symbol val'>:visit_ended</span><span class='comma token'>,</span>   <span class='self self kw'>self</span><span class='rparen token'>)</span>
<span class='end end kw'>end</span>
</pre>
        </td>
      </tr>
    </table>
  </div>
</div>
</div>
    </div>
  
    <div class="method">
      <div class="method_header">
  <h3>store_graph</h3>
</div><div id="store_graph-instance_method" class="section method">
  <div class="details_title">
    <div class='section methodsignature'>
    <tt class='def'>
      <span class='visibility'>public</span>
      <span class='return_types'></span>
      <span class='name'>store_graph</span><span class='args'></span>
      <span class='block'></span>
    </tt>
  </div>

</div><div class="section docstring">
  <p>
Stores the dependency graph into the file specified by the
<tt>filename</tt> attribute.
</p>

</div><div class="section source">
  <span>[<a class="source_link" href="#">View source</a>]</span>
  <div class="source_code">
    <table>
      <tr>
        <td>
          <pre class="lines">


138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162</pre>
        </td>
        <td>
          <pre class="code"><span class="info file"># File 'lib/nanoc3/base/dependency_tracker.rb', line 138</span>

<span class='def def kw'>def</span> <span class='store_graph identifier id'>store_graph</span>
  <span class='comment val'># Create dir</span>
  <span class='FileUtils constant id'>FileUtils</span><span class='dot token'>.</span><span class='mkdir_p identifier id'>mkdir_p</span><span class='lparen token'>(</span><span class='File constant id'>File</span><span class='dot token'>.</span><span class='dirname identifier id'>dirname</span><span class='lparen token'>(</span><span class='self self kw'>self</span><span class='dot token'>.</span><span class='filename identifier id'>filename</span><span class='rparen token'>)</span><span class='rparen token'>)</span>

  <span class='comment val'># Complete the graph</span>
  <span class='complete_graph identifier id'>complete_graph</span>

  <span class='comment val'># Convert graph of items into graph of item identifiers</span>
  <span class='new_graph identifier id'>new_graph</span> <span class='assign token'>=</span> <span class='lbrace token'>{</span><span class='rbrace token'>}</span>
  <span class='@graph ivar id'>@graph</span><span class='dot token'>.</span><span class='each_pair identifier id'>each_pair</span> <span class='do do kw'>do</span> <span class='bitor op'>|</span><span class='second_item identifier id'>second_item</span><span class='comma token'>,</span> <span class='first_items identifier id'>first_items</span><span class='bitor op'>|</span>
    <span class='comment val'># Don't store nil because that would be pointless (if first_item is</span>
    <span class='comment val'># outdated, something that does not exist is also outdatedâ€¦ makes no</span>
    <span class='comment val'># sense).</span>
    <span class='comment val'># FIXME can second_item really be nil?</span>
    <span class='next next kw'>next</span> <span class='if if_mod kw'>if</span> <span class='second_item identifier id'>second_item</span><span class='dot token'>.</span><span class='nil? fid id'>nil?</span>

    <span class='new_graph identifier id'>new_graph</span><span class='lbrack token'>[</span><span class='second_item identifier id'>second_item</span><span class='dot token'>.</span><span class='identifier identifier id'>identifier</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='first_items identifier id'>first_items</span><span class='dot token'>.</span><span class='map identifier id'>map</span> <span class='lbrace token'>{</span> <span class='bitor op'>|</span><span class='f identifier id'>f</span><span class='bitor op'>|</span> <span class='f identifier id'>f</span> <span class='andop op'>&amp;&amp;</span> <span class='f identifier id'>f</span><span class='dot token'>.</span><span class='identifier identifier id'>identifier</span> <span class='rbrace token'>}</span><span class='dot token'>.</span><span class='compact identifier id'>compact</span>
  <span class='end end kw'>end</span>

  <span class='comment val'># Store dependencies</span>
  <span class='store identifier id'>store</span> <span class='assign token'>=</span> <span class='PStore constant id'>PStore</span><span class='dot token'>.</span><span class='new identifier id'>new</span><span class='lparen token'>(</span><span class='self self kw'>self</span><span class='dot token'>.</span><span class='filename identifier id'>filename</span><span class='rparen token'>)</span>
  <span class='store identifier id'>store</span><span class='dot token'>.</span><span class='transaction identifier id'>transaction</span> <span class='do do kw'>do</span>
    <span class='store identifier id'>store</span><span class='lbrack token'>[</span><span class='symbol val'>:dependencies</span><span class='rbrack token'>]</span> <span class='assign token'>=</span> <span class='new_graph identifier id'>new_graph</span>
  <span class='end end kw'>end</span>
<span class='end end kw'>end</span>
</pre>
        </td>
      </tr>
    </table>
  </div>
</div>
</div>
    </div>
  
</div>
  </div>

</div>
    </div>
    <div id="yard_info">
  Generated on Sunday, August 09 2009 at 01:43:09 PM by 
  <abbr class="yard" title="Yay! A Ruby Documentation Tool"><a href="http://yard.soen.ca">YARD</a></abbr> 
  0.2.3.2 (ruby-1.8.7).
</div>

  </body>
</html>