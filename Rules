#!/usr/bin/env ruby

require 'susy'

preprocess do
  config[:nanoc_version_info] = Nanoc.version_information.strip
  config[:gem_version_info]   = Gem::VERSION
  config[:ruby_version_info]  = `ruby --version`.strip
  config[:generate_pdf] = !ENV['PDF'].nil?
end

layout '/**/*', :erb

ignore '/**/_*'

passthrough '/favicon.ico'
passthrough '/assets/fonts/**/*'
ignore '/assets/style/*.tex'

compile '/assets/images/hero/*' do
  digest = Digest::SHA1.hexdigest(File.read(item[:filename]))
  write item.identifier.without_ext + '-' + digest[0..15] + item.identifier.ext
end

passthrough '/assets/images/**/*'

compile '/assets/style/*' do
  filter :sass, syntax: :scss
  filter :relativize_paths, :type => :css
  filter :autoprefixer
  filter :rainpress

  data = @items.find_all('/assets/style/_*').map { |i| i.raw_content }.join('')
  digest = Digest::SHA1.hexdigest(data)
  write item.identifier.without_ext + '-' + digest[0..15] + '.css'
end

compile '/sitemap.*' do
  filter :erb
  write '/sitemap.xml'
end

compile '/robots.*' do
  filter :erb
  write '/robots.txt'
end

compile '/index.*' do
  filter :erb
  layout '/default.*'
  filter :relativize_paths, type: :html
  filter :htmlcompressor
  write '/index.html'
end

compile '/404.*' do
  filter :dmark2html
  layout '/default.*'
  filter :htmlcompressor
  write '/404.html'
end

compile '/release-notes' do
  filter :fix_contributor_brackets
  filter :kramdown, :auto_ids => false
  filter :add_ids_to_headers
  filter :link_github_issues
  layout '/default.*'
  filter :add_toc
  filter :relativize_paths, type: :html
  filter :htmlcompressor
  write item.identifier.without_ext + '/index.html'
end

compile '/**/*', rep: :latex do
  if config[:generate_pdf] && item.identifier =~ '/doc/**/*'
    case item.identifier.ext
    when 'erb'
      filter :erb
    when 'dmark'
      filter :dmark2latex
    when nil
    else
      raise
    end
    layout '/latex-chapter.erb'
  end
end

compile '/book.*' do
  if config[:generate_pdf]
    filter :erb
    layout '/latex-book.erb'
    filter :latex2pdf
    write item.identifier.without_ext + '.pdf'
  end
end

compile '/**/*' do
  case item.identifier.ext
  when 'erb'
    filter :erb
    filter :add_ids_to_headers
  when 'dmark'
    filter :dmark2html
  else
    filter :add_ids_to_headers
  end

  layout '/default.*'

  filter :add_toc
  filter :colorize_syntax, :is_fullpage => true
  filter :relativize_paths, :type => :html
  filter :htmlcompressor

  if item.binary?
    write item.identifier.to_s
  elsif item.identifier =~ '/doc/about.*'
    # TODO: Remove me, and set up a redirect from /about to /doc/about
    write '/about/index.html'
  else
    write item.identifier.without_ext + '/index.html'
  end
end
